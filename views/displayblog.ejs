<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/head') %>
    <title><%= blog.title %> | BlogSpace</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 70px;
        }

        .blog-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .blog-card-main {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .blog-header-section {
            padding: 50px 60px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .blog-title-main {
            font-size: 3rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .blog-meta-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .blog-published-date {
            color: #6c757d;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .blog-author-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #495057;
            font-size: 0.95rem;
        }

        .author-avatar-main {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
        }

        .blog-description {
            color: #6c757d;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .blog-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .blog-category {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .blog-tag {
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid;
            display: inline-block;
            margin: 5px 5px 5px 0;
        }

        .blog-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Dynamic tag colors based on hash of tag name */
        .tag-0 {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.3);
        }

        .tag-0:hover {
            background: #667eea;
            color: white;
        }

        .tag-1 {
            background: rgba(236, 72, 153, 0.1);
            color: #ec4899;
            border-color: rgba(236, 72, 153, 0.3);
        }

        .tag-1:hover {
            background: #ec4899;
            color: white;
        }

        .tag-2 {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .tag-2:hover {
            background: #f59e0b;
            color: white;
        }

        .tag-3 {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .tag-3:hover {
            background: #10b981;
            color: white;
        }

        .tag-4 {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .tag-4:hover {
            background: #ef4444;
            color: white;
        }

        .tag-default {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border-color: rgba(107, 114, 128, 0.3);
        }

        .tag-default:hover {
            background: #6b7280;
            color: white;
        }

        .blog-hero-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 15px;
            margin: 30px 60px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .blog-content-section {
            padding: 40px 60px 50px;
        }

        .blog-content-main {
            color: #2c3e50;
            font-size: 1.1rem;
            line-height: 1.8;
            max-width: 800px;
        }

        .blog-content-main h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .blog-content-main h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 30px 0 15px;
        }

        .blog-content-main p {
            margin-bottom: 20px;
        }

        .blog-content-main ul,
        .blog-content-main ol {
            margin: 20px 0;
            padding-left: 30px;
        }

        .blog-content-main li {
            margin-bottom: 10px;
        }

        .blog-quote {
            margin: 40px 0;
            padding: 30px 40px;
            border-left: 5px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 10px;
            font-style: italic;
            position: relative;
        }

        .blog-quote::before {
            content: '"';
            font-size: 5rem;
            color: #667eea;
            position: absolute;
            top: -10px;
            left: 15px;
            opacity: 0.2;
            font-family: serif;
        }

        .blog-quote-text {
            font-size: 1.2rem;
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .blog-quote-author {
            font-size: 1rem;
            color: #667eea;
            font-weight: 600;
            font-style: normal;
        }

        .blog-footer-section {
            padding: 30px 60px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .read-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-size: 0.95rem;
        }

        .blog-actions {
            display: flex;
            gap: 15px;
        }

        .btn-share {
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid #e9ecef;
            background: white;
            color: #6c757d;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-share:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .author-profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .author-social-links {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .social-link-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            color: #6c757d;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            font-size: 1.1rem;
        }

        .social-link-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .social-link-item.fa-twitter:hover {
            background: #1DA1F2;
            border-color: #1DA1F2;
        }

        .social-link-item.fa-instagram:hover {
            background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
            border-color: #bc1888;
        }

        .social-link-item.fa-facebook:hover {
            background: #1877F2;
            border-color: #1877F2;
        }

        .social-link-item.fa-linkedin:hover {
            background: #0077b5;
            border-color: #0077b5;
        }

        .social-link-item.fa-github:hover {
            background: #333;
            border-color: #333;
        }

        .social-link-item.fa-envelope:hover {
            background: #ea4335;
            border-color: #ea4335;
        }

        .btn-follow-author {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-follow-author:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-follow-author.following {
            background: #6c757d;
        }

        .btn-follow-author.following:hover {
            background: #5a6268;
        }

        .back-button {
            margin-bottom: 30px;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            color: #6c757d;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateX(-5px);
        }

        @media (max-width: 768px) {
            .blog-header-section,
            .blog-content-section,
            .blog-footer-section {
                padding: 30px 25px;
            }

            .blog-hero-image {
                margin: 20px 25px;
                height: 300px;
                border-radius: 10px;
            }

            .blog-title-main {
                font-size: 2rem;
            }

            .blog-content-main {
                font-size: 1rem;
            }

            .blog-quote {
                padding: 20px 25px;
            }

            .blog-quote-text {
                font-size: 1rem;
            }

            .blog-footer-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .author-profile-image {
                width: 100px;
                height: 100px;
            }

            .author-social-links {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <%- include("./partials/nav") %>

    <div class="blog-detail-container">
        <!-- Back Button -->
        <div class="back-button">
            <a href="javascript:history.back()" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                Back to Blogs
            </a>
        </div>

        <!-- Main Blog Card -->
        <div class="blog-card-main">
            <!-- Header Section -->
            <div class="blog-header-section">
                <h1 class="blog-title-main"><%= blog.title %></h1>
                
                <div class="blog-meta-main">
                    <div class="blog-published-date">
                        <i class="fas fa-calendar-alt"></i>
                        Published <%= new Date(blog.createdat).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) %>
                    </div>
                    <div class="blog-author-info">
                        <img src="<%= blog.createdby?.profileImage || '/public/images/default.png' %>" 
                             alt="<%= blog.createdby?.fullname || 'Author' %>" 
                             class="author-avatar-main"
                             onerror="this.src='/public/images/default.png'">
                        <span><%= blog.createdby?.fullname || 'Anonymous' %></span>
                    </div>
                </div>

                <p class="blog-description">
                    <%= blog.content.replace(/<[^>]*>/g, '').substring(0, 150) %>...
                </p>

                <!-- Category and Tags -->
                <div style="margin-top: 25px;">
                    <!-- Category -->
                    <% if (blog.category && blog.category.trim() !== '') { %>
                        <div class="blog-category" style="margin-bottom: 15px;">
                            <i class="fas fa-folder me-2"></i><%= blog.category %>
                        </div>
                    <% } %>

                    <!-- Tags -->
                    <% if (blog.tags && Array.isArray(blog.tags) && blog.tags.length > 0) { %>
                        <div class="blog-tags" style="margin-top: 10px;">
                            <% blog.tags.forEach(function(tag, index) { 
                                if (tag && tag.trim() !== '') {
                                    const tagClass = 'tag-' + (index % 5); // Cycle through 5 tag colors
                            %>
                                <span class="blog-tag <%= tagClass %>">
                                    <i class="fas fa-tag me-2"></i><%= tag.trim() %>
                                </span>
                            <% }
                                }); %>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Hero Image -->
            <% if (blog.coverimage) { %>
                <img src="<%= blog.coverimage && blog.coverimage.startsWith('/public/') ? blog.coverimage : '/public' + blog.coverimage %>" 
                     alt="<%= blog.title %>" 
                     class="blog-hero-image"
                     onerror="this.src='/public/images/default.png'">
            <% } %>

          
            <div class="blog-content-section">
                <div class="blog-content-main">
                    <%- blog.content %>
                </div>
            </div>

            <!-- Footer Section -->
            <div class="blog-footer-section">
                <div class="read-time">
                    <i class="far fa-clock"></i>
                    <span><%= Math.ceil(blog.content.replace(/<[^>]*>/g, '').length / 1000) %> min read</span>
                </div>
                <div class="blog-actions">
                    <button class="btn-share like-btn-display" 
                            data-blog-id="<%= blog._id %>" 
                            data-liked="<%= isLiked ? '1' : '0' %>">
                        <i class="fas fa-heart <%= isLiked ? 'text-danger' : '' %>"></i>
                        <span class="like-count"><%= likes || 0 %></span>
                    </button>
                    <a href="#" class="btn-share" onclick="shareBlog(); return false;">
                        <i class="fas fa-share-alt"></i>
                        Share
                    </a>
                    <a href="#" class="btn-share" onclick="window.print(); return false;">
                        <i class="fas fa-print"></i>
                        Print
                    </a>
                </div>
            </div>
        </div>

        <!-- Author Profile Section -->
        <div class="blog-card-main" style="margin-top: 40px;">
            <div class="blog-header-section">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <img src="<%= blog.createdby?.profileImage || '/public/images/default.png' %>" 
                         alt="<%= blog.createdby?.fullname || 'Author' %>" 
                         class="author-profile-image"
                         onerror="this.src='/public/images/default.png'">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1.5rem;">
                                    <%= blog.createdby?.fullname || 'Anonymous' %>
                                </h3>
                            </div>
                            <% if (blog.createdby && user && blog.createdby._id.toString() !== user._id.toString()) { %>
                                <button id="followBtn" 
                                        class="btn-follow-author" 
                                        data-author-id="<%= blog.createdby._id %>">
                                    <i class="fas fa-user-plus me-2"></i>
                                    <span id="followBtnText">Follow</span>
                                </button>
                            <% } %>
                        </div>
                        <% if (blog.createdby?.bio) { %>
                            <p style="color: #6c757d; margin: 0 0 10px 0; line-height: 1.6;">
                                <%= blog.createdby.bio %>
                            </p>
                        <% } %>
                        <% if (blog.createdby?.location) { %>
                            <div style="color: #868e96; margin-bottom: 15px;">
                                <i class="fas fa-map-marker-alt me-2"></i><%= blog.createdby.location %>
                            </div>
                        <% } %>
                        <div class="author-social-links">
                            <% if (blog.createdby?.twitter) { %>
                                <a href="<%= blog.createdby.twitter.startsWith('http') ? blog.createdby.twitter : 'https://twitter.com/' + blog.createdby.twitter %>" 
                                   target="_blank" 
                                   class="social-link-item" 
                                   title="Twitter">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            <% } %>
                            <% if (blog.createdby?.instagram) { %>
                                <a href="<%= blog.createdby.instagram.startsWith('http') ? blog.createdby.instagram : 'https://instagram.com/' + blog.createdby.instagram %>" 
                                   target="_blank" 
                                   class="social-link-item" 
                                   title="Instagram">
                                    <i class="fab fa-instagram"></i>
                                </a>
                            <% } %>
                            <% if (blog.createdby?.facebook) { %>
                                <a href="<%= blog.createdby.facebook.startsWith('http') ? blog.createdby.facebook : 'https://facebook.com/' + blog.createdby.facebook %>" 
                                   target="_blank" 
                                   class="social-link-item" 
                                   title="Facebook">
                                    <i class="fab fa-facebook"></i>
                                </a>
                            <% } %>
                            <% if (blog.createdby?.linkedin) { %>
                                <a href="<%= blog.createdby.linkedin.startsWith('http') ? blog.createdby.linkedin : 'https://linkedin.com/in/' + blog.createdby.linkedin %>" 
                                   target="_blank" 
                                   class="social-link-item" 
                                   title="LinkedIn">
                                    <i class="fab fa-linkedin"></i>
                                </a>
                            <% } %>
                            <% if (blog.createdby?.github) { %>
                                <a href="<%= blog.createdby.github.startsWith('http') ? blog.createdby.github : 'https://github.com/' + blog.createdby.github %>" 
                                   target="_blank" 
                                   class="social-link-item" 
                                   title="GitHub">
                                    <i class="fab fa-github"></i>
                                </a>
                            <% } %>
                            <% if (blog.createdby?.email) { %>
                                <a href="mailto:<%= blog.createdby.email %>" 
                                   class="social-link-item" 
                                   title="Email">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('./partials/script') %>

    <script>
        // Blog data for sharing
        var blogShareData = {
            title: <%- JSON.stringify(blog.title) %>,
            text: <%- JSON.stringify(blog.content.replace(/<[^>]*>/g, '').substring(0, 100)) %>,
            url: window.location.href
        };

        // Share blog functionality
        function shareBlog() {
            var shareData = {
                title: blogShareData.title,
                text: blogShareData.text + '...',
                url: blogShareData.url
            };
            
            if (navigator.share) {
                navigator.share(shareData).catch(function(err) {
                    console.log('Error sharing:', err);
                });
            } else {
                // Fallback: Copy to clipboard
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(window.location.href).then(function() {
                        alert('Link copied to clipboard!');
                    }).catch(function(err) {
                        console.log('Error copying:', err);
                    });
                } else {
                    alert('Sharing not supported in this browser');
                }
            }
        }

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Follow/Unfollow functionality
        const followBtn = document.getElementById('followBtn');
        if (followBtn) {
            const authorId = followBtn.getAttribute('data-author-id');
            const followBtnText = document.getElementById('followBtnText');
            var isFollowing = Boolean(<%- (typeof isFollowing !== 'undefined' && isFollowing) ? 1 : 0 %>);

            // Update button state on load
            if (isFollowing) {
                followBtn.classList.add('following');
                followBtnText.innerHTML = '<i class="fas fa-check me-2"></i>Following';
            }

            followBtn.addEventListener('click', async function() {
                if (!authorId) return;

                followBtn.disabled = true;
                const originalText = followBtnText.innerHTML;
                followBtnText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>...';

                try {
                    const response = await fetch('/follow/' + authorId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (data.success) {
                        isFollowing = data.isFollowing;
                        
                        if (isFollowing) {
                            followBtn.classList.add('following');
                            followBtnText.innerHTML = '<i class="fas fa-check me-2"></i>Following';
                        } else {
                            followBtn.classList.remove('following');
                            followBtnText.innerHTML = '<i class="fas fa-user-plus me-2"></i>Follow';
                        }
                    } else {
                        alert(data.message || 'Error following user');
                        followBtnText.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    followBtnText.innerHTML = originalText;
                } finally {
                    followBtn.disabled = false;
                }
            });
        }

        // Like button functionality
        const likeBtn = document.querySelector('.like-btn-display');
        if (likeBtn) {
            likeBtn.addEventListener('click', async function() {
                const blogId = this.getAttribute('data-blog-id');
                const liked = this.getAttribute('data-liked') === '1';
                const likeCountEl = this.querySelector('.like-count');
                const icon = this.querySelector('i');
                const original = likeCountEl.textContent;

                // Disable button during request
                this.disabled = true;

                // Optimistic UI
                let currentLikes = parseInt(original || '0', 10);
                if (liked) {
                    currentLikes = Math.max(0, currentLikes - 1);
                    this.setAttribute('data-liked', '0');
                    icon.classList.remove('text-danger');
                } else {
                    currentLikes += 1;
                    this.setAttribute('data-liked', '1');
                    icon.classList.add('text-danger');
                }
                likeCountEl.textContent = currentLikes;

                try {
                    const res = await fetch('/blog/like/' + blogId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (!data.success) {
                        throw new Error(data.message || 'Failed');
                    }
                    likeCountEl.textContent = data.likes ?? currentLikes;
                    this.setAttribute('data-liked', data.liked ? '1' : '0');
                    if (data.liked) {
                        icon.classList.add('text-danger');
                    } else {
                        icon.classList.remove('text-danger');
                    }
                } catch (err) {
                    // revert on error
                    this.setAttribute('data-liked', liked ? '1' : '0');
                    likeCountEl.textContent = original;
                    if (liked) {
                        icon.classList.add('text-danger');
                    } else {
                        icon.classList.remove('text-danger');
                    }
                    alert('Unable to update like. Please try again.');
                    console.error(err);
                } finally {
                    this.disabled = false;
                }
            });
        }
    </script>
</body>

</html>

